import json
import re
import subprocess
import sys
import time

PROD_DELAY = 45
DEV_DELAY = 5
PROD_MINUS = 30
DEV_MINUS = 0
MAX_FIELDS = 16

# GAME CONFIG

ROWS = 4
COLUMNS = 2
IS_PROD = False

if ROWS == 4:
    game_obj = {'0': [['1', '5', '4', '3', '3', '4', '5', '5', '4', '3', '3', '3', '2', '2', '2', '3'], ['2', '5', '4', '3', '3', '3', '4', '4', '3', '3', '3', '3', '2', '2', '2', '3'], ['3', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '1', '2', '3', '3'], ['3', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '1', '2', '3', '3'], ['4', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '1', '2', '3', '3'], ['4', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '2', '3', '3', '3'], ['4', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3'], ['4', '5', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3']], '1': [['4', '5', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3'], ['5', '4', '3', '3', '3', '3', '3', '3', '2', '3', '3', '3', '3', '3', '3', '3'], ['5', '4', '3', '3', '3', '3', '3', '2', '2', '3', '3', '3', '3', '3', '4', '3'], ['5', '3', '3', '3', '3', '4', '3', '2', '2', '2', '3', '3', '3', '3', '4', '4'], ['5', '3', '3', '3', '4', '5', '2', '2', '2', '2', '2', '3', '3', '3', '4', '4'], ['4', '3', '3', '4', '5', '4', '2', '2', '2', '2', '2', '2', '3', '3', '3', '2'], ['3', '3', '4', '4', '5', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2'], ['3', '4', '4', '5', '4', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2']], '2': [['4', '4', '5', '5', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2'], ['4', '4', '5', '2', '2', '2', '2', '4', '2', '2', '2', '2', '2', '2', '2', '2'], ['4', '5', '4', '1', '2', '2', '2', '4', '5', '2', '2', '2', '2', '2', '2', '2'], ['4', '5', '1', '1', '2', '2', '2', '3', '5', '4', '2', '2', '2', '2', '2', '4'], ['5', '4', '1', '1', '2', '2', '2', '2', '5', '5', '2', '2', '3', '5', '5', '5'], ['5', '1', '1', '1', '2', '2', '2', '2', '4', '5', '5', '5', '5', '4', '4', '4'], ['5', '1', '1', '1', '2', '2', '2', '2', '5', '5', '5', '4', '3', '3', '4', '4'], ['5', '5', '1', '1', '2', '2', '4', '5', '5', '5', '4', '3', '3', '4', '4', '4']], '3': [['5', '5', '5', '4', '4', '5', '5', '4', '4', '5', '4', '3', '3', '4', '4', '4'], ['5', '4', '5', '5', '5', '4', '4', '3', '4', '5', '4', '3', '3', '4', '4', '5'], ['5', '5', '4', '4', '4', '3', '3', '3', '4', '5', '4', '3', '4', '5', '5', '5'], ['5', '5', '4', '4', '4', '3', '3', '3', '4', '5', '3', '4', '5', '5', '5', '5'], ['4', '5', '4', '4', '4', '3', '3', '3', '4', '4', '4', '5', '5', '5', '5', '5'], ['5', '5', '4', '4', '4', '3', '3', '3', '3', '4', '5', '5', '5', '5', '5', '5'], ['5', '4', '4', '4', '4', '3', '3', '3', '3', '5', '5', '5', '5', '5', '5', '5'], ['5', '3', '4', '4', '4', '3', '3', '3', '4', '5', '5', '5', '5', '5', '5', '5']], '4': [['2', '2', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '4', '4', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '4', '4', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '4', '4', '4'], ['2', '1', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '5', '4', '4'], ['2', '1', '1', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '5', '4', '4'], ['2', '1', '1', '2', '2', '2', '2', '2', '2', '4', '5', '4', '5', '5', '4', '4'], ['2', '1', '1', '2', '2', '2', '2', '2', '3', '4', '5', '4', '4', '5', '4', '4'], ['2', '1', '2', '2', '2', '2', '2', '2', '3', '4', '5', '4', '2', '5', '5', '4']], '5': [['2', '2', '2', '2', '2', '2', '2', '2', '3', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '3', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '4', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '4', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '3', '4', '4', '5', '2', '1', '4', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '3', '4', '4', '5', '1', '1', '4', '5', '4'], ['2', '2', '2', '2', '2', '2', '3', '4', '4', '5', '5', '1', '2', '4', '5', '4'], ['2', '2', '2', '2', '2', '3', '3', '4', '4', '5', '5', '1', '2', '3', '5', '5']], '6': [['2', '2', '2', '2', '2', '3', '4', '4', '4', '5', '2', '2', '2', '2', '5', '5'], ['2', '2', '2', '2', '3', '4', '4', '4', '5', '5', '2', '2', '2', '2', '5', '5'], ['2', '2', '4', '4', '5', '5', '5', '5', '5', '4', '2', '2', '2', '2', '5', '5'], ['5', '5', '5', '5', '4', '4', '4', '5', '5', '2', '2', '2', '2', '2', '5', '5'], ['5', '4', '4', '4', '4', '4', '5', '5', '2', '2', '2', '2', '2', '2', '5', '5'], ['4', '4', '5', '5', '5', '5', '4', '2', '2', '2', '2', '2', '2', '2', '3', '5'], ['4', '5', '5', '4', '3', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '5'], ['4', '5', '5', '1', '1', '1', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2']], '7': [['4', '5', '5', '2', '1', '1', '1', '1', '1', '1', '1', '2', '2', '2', '2', '2'], ['5', '5', '5', '5', '4', '1', '1', '1', '1', '2', '2', '2', '2', '2', '3', '3'], ['5', '5', '5', '5', '5', '5', '5', '5', '3', '2', '3', '3', '3', '3', '3', '3'], ['5', '5', '5', '5', '4', '4', '4', '5', '5', '5', '5', '4', '4', '3', '3', '3'], ['5', '5', '5', '5', '4', '4', '4', '4', '4', '4', '5', '5', '5', '4', '3', '2'], ['5', '5', '5', '5', '5', '4', '4', '4', '3', '3', '3', '4', '4', '4', '5', '4'], ['5', '5', '5', '5', '5', '5', '5', '4', '4', '4', '4', '4', '4', '4', '4', '4'], ['5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '4', '4', '4']]}

else:
    game_obj = {'0': [['1', '5', '4', '3', '3', '4', '5', '5', '4', '3', '3', '3', '2', '2', '2', '3'], ['2', '5', '4', '3', '3', '3', '4', '4', '3', '3', '3', '3', '2', '2', '2', '3'], ['3', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '1', '2', '3', '3'], ['3', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '1', '2', '3', '3'], ['4', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '1', '2', '3', '3'], ['4', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '2', '3', '3', '3'], ['4', '5', '4', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3'], ['4', '5', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3']], '1': [['4', '5', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3', '3'], ['5', '4', '3', '3', '3', '3', '3', '3', '2', '3', '3', '3', '3', '3', '3', '3'], ['5', '4', '3', '3', '3', '3', '3', '2', '2', '3', '3', '3', '3', '3', '4', '3'], ['5', '3', '3', '3', '3', '4', '3', '2', '2', '2', '3', '3', '3', '3', '4', '4'], ['5', '3', '3', '3', '4', '5', '2', '2', '2', '2', '2', '3', '3', '3', '4', '4'], ['4', '3', '3', '4', '5', '4', '2', '2', '2', '2', '2', '2', '3', '3', '3', '2'], ['3', '3', '4', '4', '5', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2'], ['3', '4', '4', '5', '4', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2']], '2': [['4', '4', '5', '5', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2'], ['4', '4', '5', '2', '2', '2', '2', '4', '2', '2', '2', '2', '2', '2', '2', '2'], ['4', '5', '4', '1', '2', '2', '2', '4', '5', '2', '2', '2', '2', '2', '2', '2'], ['4', '5', '1', '1', '2', '2', '2', '3', '5', '4', '2', '2', '2', '2', '2', '4'], ['5', '4', '1', '1', '2', '2', '2', '2', '5', '5', '2', '2', '3', '5', '5', '5'], ['5', '1', '1', '1', '2', '2', '2', '2', '4', '5', '5', '5', '5', '4', '4', '4'], ['5', '1', '1', '1', '2', '2', '2', '2', '5', '5', '5', '4', '3', '3', '4', '4'], ['5', '5', '1', '1', '2', '2', '4', '5', '5', '5', '4', '3', '3', '4', '4', '4']], '3': [['5', '5', '5', '4', '4', '5', '5', '4', '4', '5', '4', '3', '3', '4', '4', '4'], ['5', '4', '5', '5', '5', '4', '4', '3', '4', '5', '4', '3', '3', '4', '4', '5'], ['5', '5', '4', '4', '4', '3', '3', '3', '4', '5', '4', '3', '4', '5', '5', '5'], ['5', '5', '4', '4', '4', '3', '3', '3', '4', '5', '3', '4', '5', '5', '5', '5'], ['4', '5', '4', '4', '4', '3', '3', '3', '4', '4', '4', '5', '5', '5', '5', '5'], ['5', '5', '4', '4', '4', '3', '3', '3', '3', '4', '5', '5', '5', '5', '5', '5'], ['5', '4', '4', '4', '4', '3', '3', '3', '3', '5', '5', '5', '5', '5', '5', '5'], ['5', '3', '4', '4', '4', '3', '3', '3', '4', '5', '5', '5', '5', '5', '5', '5']], '4': [['2', '2', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '4', '4', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '4', '4', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '4', '4', '4'], ['2', '1', '2', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '5', '4', '4'], ['2', '1', '1', '2', '2', '2', '2', '2', '2', '4', '5', '5', '5', '5', '4', '4'], ['2', '1', '1', '2', '2', '2', '2', '2', '2', '4', '5', '4', '5', '5', '4', '4'], ['2', '1', '1', '2', '2', '2', '2', '2', '3', '4', '5', '4', '4', '5', '4', '4'], ['2', '1', '2', '2', '2', '2', '2', '2', '3', '4', '5', '4', '2', '5', '5', '4']], '5': [['2', '2', '2', '2', '2', '2', '2', '2', '3', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '3', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '4', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '2', '4', '4', '5', '4', '1', '5', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '3', '4', '4', '5', '2', '1', '4', '5', '4'], ['2', '2', '2', '2', '2', '2', '2', '3', '4', '4', '5', '1', '1', '4', '5', '4'], ['2', '2', '2', '2', '2', '2', '3', '4', '4', '5', '5', '1', '2', '4', '5', '4'], ['2', '2', '2', '2', '2', '3', '3', '4', '4', '5', '5', '1', '2', '3', '5', '5']], '6': [['2', '2', '2', '2', '2', '3', '4', '4', '4', '5', '2', '2', '2', '2', '5', '5'], ['2', '2', '2', '2', '3', '4', '4', '4', '5', '5', '2', '2', '2', '2', '5', '5'], ['2', '2', '4', '4', '5', '5', '5', '5', '5', '4', '2', '2', '2', '2', '5', '5'], ['5', '5', '5', '5', '4', '4', '4', '5', '5', '2', '2', '2', '2', '2', '5', '5'], ['5', '4', '4', '4', '4', '4', '5', '5', '2', '2', '2', '2', '2', '2', '5', '5'], ['4', '4', '5', '5', '5', '5', '4', '2', '2', '2', '2', '2', '2', '2', '3', '5'], ['4', '5', '5', '4', '3', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2', '5'], ['4', '5', '5', '1', '1', '1', '2', '2', '2', '2', '2', '2', '2', '2', '2', '2']], '7': [['4', '5', '5', '2', '1', '1', '1', '1', '1', '1', '1', '2', '2', '2', '2', '2'], ['5', '5', '5', '5', '4', '1', '1', '1', '1', '2', '2', '2', '2', '2', '3', '3'], ['5', '5', '5', '5', '5', '5', '5', '5', '3', '2', '3', '3', '3', '3', '3', '3'], ['5', '5', '5', '5', '4', '4', '4', '5', '5', '5', '5', '4', '4', '3', '3', '3'], ['5', '5', '5', '5', '4', '4', '4', '4', '4', '4', '5', '5', '5', '4', '3', '2'], ['5', '5', '5', '5', '5', '4', '4', '4', '3', '3', '3', '4', '4', '4', '5', '4'], ['5', '5', '5', '5', '5', '5', '5', '4', '4', '4', '4', '4', '4', '4', '4', '4'], ['5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '5', '4', '4', '4']]}

COLORS_BW = [16711422, 11186364, 7237230, 3093818, 1974824]
COLORS_SPARTA = [16708566, 14919490, 11629353, 8529680, 0]
COLORS_RENOIR = [12489584, 9008440, 6708542, 7617068, 4274740]
COLORS_EVERSCALE = [16777215, 6508529, 16542001, 2301620, 856370]
COLORS_ROYAL = [2754884, 11186364, 14031950, 2700386, 6360163]
COLORS_NEW = [16702908, 16767151, 16565341, 13209133, 4925198]

COLORS = COLORS_NEW
GAME_NAME = "Skull 7 x 4"
GAME_START_TIME = 0
#GAME_START_TIME = 1667120274

game_extra_settings = [10, 100, 0, 5]


if IS_PROD:
    # MAIN
    PLAYER_ADDRESS = '0:2fe4baae0aa7bc92c919590b9db34c6272fd49161faaf4336ac2efb8c2228e62'
    QUEUE = '0:9a47d9d333c988e0a734492c2dab3b297c04061c7f6d261b2aefef4bf3b7198b'
    SIGNER_NAME = 'pile_signer'
    NETWORK = 'main'
    op_delay = PROD_DELAY
    op_minus = PROD_DELAY
else:
    # SE
    #PLAYER_ADDRESS = '0:a8991421da84b6a1a95602f6e8f73095815f407e256b898e4efddb3be99154bf'
    #QUEUE = '0:b77e56a39128ab870570725ef978163d58a8a091db5a5123bf2fadecf83675a8'

    # DEV
    PLAYER_ADDRESS = '0:09abcc263db0683a688394e36cf7987f9000a5508d7ed69e20f1dd8dd1717141'
    QUEUE = '0:b51b3cdc14e0045fd7534dac25063c4d27fcb85edb3632ce083db9c7997f995d'
    SIGNER_NAME = 'norton'
    NETWORK = 'dev'
    op_delay = DEV_DELAY
    op_minus = DEV_MINUS


def filter_gen():
    counter = 0
    n = 0
    while True:
        if 0 <= counter < 4:
            yield True
        if 4 <= counter < 8:
            yield False
        if counter == 8:
            counter = 0
            continue
        n += 1
        counter += 1


del_filter = filter_gen()

filtered_values = [i for i in range(MAX_FIELDS) if next(del_filter)]

"""
if ROWS * COLUMNS < MAX_FIELDS:
    print(filtered_values)
    for i in range(MAX_FIELDS):
        if i not in filtered_values:
            del game_obj[str(i)]

"""

print(game_obj)

game_settings = {"_renderSettings": [ROWS, COLUMNS, 1, 5, *COLORS],
                 "_gameName": GAME_NAME, "_gameStartTime": GAME_START_TIME}




def find_address(field, text):
    m = re.search("{0}\"\:\s\"([^\"]*)\"".format(field), str(text))
    if m:
        return m.group(1)


subprocess.call(
    ['C:/Users/home/AppData/Roaming/npm/everdev', 'contract', 'run', '../PlayerTest.abi.json', '-a', PLAYER_ADDRESS,
     '-s', SIGNER_NAME, '-n', NETWORK, 'deployGame', '-i', json.dumps(game_settings)], shell=True, stdout=subprocess.DEVNULL)

time.sleep(op_delay)

out = subprocess.run(
    ['C:/Users/home/AppData/Roaming/npm/everdev', 'contract', 'run-local', '../PlayerTest.abi.json', '-a',
     PLAYER_ADDRESS,
     '-s', SIGNER_NAME, '-n', NETWORK, 'gameAddress'], shell=True, stdout=subprocess.PIPE)

GAME_ADDRESS = find_address('gameAddress', out.stdout)
print("GAME ADDRESS: {}".format(GAME_ADDRESS))

fragment_counter = 0

for i in game_obj:

    print(json.dumps({"fragmentNum": fragment_counter, "tiles": game_obj[i]}))

    subprocess.call(
        ['C:/Users/home/AppData/Roaming/npm/everdev', 'contract', 'run', '../PlayerTest.abi.json', '-a', PLAYER_ADDRESS,
         '-s', SIGNER_NAME, '-n', NETWORK, 'saveImageFragment', '-i',
         json.dumps({"fragmentNum": fragment_counter, "tiles": game_obj[i]})], shell=True, stdout=subprocess.DEVNULL)
    time.sleep(op_delay - op_minus)
    fragment_counter += 1

subprocess.call(
    ['C:/Users/home/AppData/Roaming/npm/everdev', 'contract', 'run', '../PlayerTest.abi.json', '-a', PLAYER_ADDRESS,
     '-s', SIGNER_NAME, '-n', NETWORK, 'setGameExtraSettings', '-i',
     json.dumps({'_extraSettings': game_extra_settings})], shell=True, stdout=subprocess.DEVNULL)
print(json.dumps({'_extraSettings': game_extra_settings}))

time.sleep(op_delay - op_minus)

subprocess.call(
    ['C:/Users/home/AppData/Roaming/npm/everdev', 'contract', 'run', '../PlayerTest.abi.json', '-a', PLAYER_ADDRESS,
     '-s', SIGNER_NAME, '-n', NETWORK, 'setImageForReview'], shell=True, stdout=subprocess.DEVNULL)

print("everdev contract run-local PBGame.abi.json -a {game} -n {nwk} getInfo".format(game=GAME_ADDRESS, nwk=NETWORK))

print("everdev contract run GameQueue.abi.json -a {queue} -n {nwk} addGame -i '{{\"gameAddress\": \"{game}\"}}' -s pile_signer".format(game=GAME_ADDRESS, nwk=NETWORK, queue=QUEUE))
